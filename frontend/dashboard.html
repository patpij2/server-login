<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Simple Login System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        textarea {
            font-family: Arial, sans-serif;
        }
        .dashboard-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .welcome {
            font-size: 24px;
            color: #333;
        }
        .logout-btn {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        .dashboard-content {
            text-align: center;
            padding: 40px 0;
        }
        
        /* Collapsible Sections Styles */
        .dashboard-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 16px;
            transition: background 0.3s ease;
            user-select: none;
        }
        
        .section-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%);
        }
        
        .section-header.memory { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .section-header.integrations { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .section-header.scraping { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .section-header.social-media { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .section-header.data-management { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .section-header.memory:hover { background: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%); }
        .section-header.integrations:hover { background: linear-gradient(135deg, #e084e9 0%, #e34e5a 100%); }
        .section-header.scraping:hover { background: linear-gradient(135deg, #3d9bec 0%, #00e0ec 100%); }
        .section-header.social-media:hover { background: linear-gradient(135deg, #ff8a8e 0%, #fdbfdf 100%); }
        .section-header.data-management:hover { background: linear-gradient(135deg, #3ad769 0%, #30e7c5 100%); }
        
        .section-toggle {
            font-size: 18px;
            transition: transform 0.3s ease;
        }
        
        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .section-content {
            padding: 20px;
            display: none;
            background: #fafafa;
        }
        
        .section-content.active {
            display: block;
        }
        
        .subsection {
            background: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .subsection h3 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .section-summary {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        .dashboard-title {
            font-size: 32px;
            color: #007bff;
            margin-bottom: 20px;
        }
        .dashboard-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
        .user-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .user-email {
            font-size: 18px;
            color: #333;
            font-weight: bold;
        }
        .back-to-login {
            margin-top: 30px;
        }
        .back-to-login a {
            color: #007bff;
            text-decoration: none;
        }
        .back-to-login a:hover {
            text-decoration: underline;
        }
        .memory-section { margin-top: 40px; text-align: left; }
        .memory-section h2 { text-align: center; margin-bottom: 20px; color: #333; }
        #memoryForm textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        #memoryForm button { width: 100%; background-color: #28a745; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        #memoryForm button:hover { background-color: #218838; }
        #memoryMessage { margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center; }
        #memoryMessage.success { background-color: #d4edda; color: #155724; }
        #memoryMessage.error { background-color: #f8d7da; color: #721c24; }
        .search-section { margin-top: 40px; text-align: left; border-top: 2px solid #f0f0f0; padding-top: 30px; }
        .search-section h2 { text-align: center; margin-bottom: 20px; color: #333; }
        #searchForm input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        #searchForm button { width: 100%; background-color: #007bff; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        #searchForm button:hover { background-color: #0056b3; }
        #searchResults { margin-top: 20px; }
        .result-item { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .result-item h3 { margin-top: 0; color: #0056b3; }
        .result-item p { white-space: pre-wrap; word-wrap: break-word; }
        .result-item .score { font-size: 0.9em; color: #6c757d; text-align: right; }
        .qa-section { 
            margin-top: 40px; 
            text-align: left; 
            border-top: 2px solid #f0f0f0; 
            padding-top: 30px; 
        }
        .qa-section h2 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: #333; 
        }
        .qa-section h2::before {
            content: "ü§ñ ";
        }
        #qaForm input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 16px; 
            box-sizing: border-box; 
            margin-bottom: 10px; 
        }
        #qaForm button { 
            width: 100%; 
            background-color: #6f42c1; 
            color: white; 
            padding: 12px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
        }
        #qaForm button:hover { 
            background-color: #5a32a3; 
        }
        #qaForm button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        #qaResults { 
            margin-top: 20px; 
        }
        .qa-item { 
            background-color: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px; 
        }
        .qa-question { 
            font-weight: bold; 
            color: #6f42c1; 
            margin-bottom: 10px; 
        }
        .qa-answer { 
            background-color: white; 
            padding: 10px; 
            border-radius: 5px; 
            border-left: 4px solid #6f42c1; 
        }
        .loading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Batch scraping styles */
        .batch-summary {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .batch-summary h3 {
            margin-top: 0;
            color: #333;
            text-align: center;
        }
        .batch-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .batch-table th,
        .batch-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .batch-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        .success-row {
            background-color: #f8fff9;
        }
        .error-row {
            background-color: #fff8f8;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-badge.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-badge.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .batch-results {
            margin-bottom: 30px;
        }
        .batch-results h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .combined-emails {
            margin-bottom: 30px;
        }
        .combined-emails h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        /* Export section styles */
        .export-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
        }
        .export-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .export-btn {
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .export-btn:hover {
            background-color: #218838;
        }
        .export-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .export-info {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        /* CSV Files Section Styles */
        .csv-files-section {
            margin-top: 40px;
            text-align: left;
            border-top: 2px solid #f0f0f0;
            padding-top: 30px;
        }
        .csv-files-section h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .csv-files-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .refresh-btn, .cleanup-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn {
            background-color: #007bff;
            color: white;
        }
        .refresh-btn:hover {
            background-color: #0056b3;
        }
        .cleanup-btn {
            background-color: #6c757d;
            color: white;
        }
        .cleanup-btn:hover {
            background-color: #545b62;
        }
        .csv-files-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .csv-files-table th,
        .csv-files-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .csv-files-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        .csv-file-actions {
            display: flex;
            gap: 5px;
        }
        .csv-download-btn, .csv-delete-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .csv-download-btn {
            background-color: #28a745;
            color: white;
        }
        .csv-download-btn:hover {
            background-color: #218838;
        }
        .csv-delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .csv-delete-btn:hover {
            background-color: #c82333;
        }
        .csv-file-size {
            font-size: 0.9em;
            color: #6c757d;
        }
        .csv-file-date {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        /* Email Schema Section Styles */
        .email-schema-section { 
            margin-top: 40px; 
            text-align: left; 
            border-top: 2px solid #f0f0f0; 
            padding-top: 30px; 
        }
        .email-schema-section h2 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: #333; 
        }
        .email-schema-section h2::before {
            content: "üéØ ";
        }
        .section-description {
            text-align: center;
            color: #6c757d;
            margin-bottom: 20px;
            font-style: italic;
        }
        #emailSchemaForm textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 16px; 
            box-sizing: border-box; 
            margin-bottom: 10px; 
            min-height: 80px;
            resize: vertical;
        }
        #emailSchemaForm button { 
            width: 100%; 
            background-color: #28a745; 
            color: white; 
            padding: 12px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
        }
        #emailSchemaForm button:hover { 
            background-color: #218838; 
        }
        #emailSchemaForm button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        #emailSchemaResults { 
            margin-top: 20px; 
        }
        .schema-item { 
            background-color: #f8f9fa; 
            border: 1px solid #e9ecef; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 15px; 
        }
        .schema-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .schema-subject {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1em;
        }
        .schema-tone {
            background-color: #e8f5e8;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .schema-body {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin: 15px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .schema-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .schema-key-points {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }
        .schema-key-points h4 {
            margin-top: 0;
            color: #856404;
        }
        .schema-key-points ul {
            margin: 0;
            padding-left: 20px;
        }
        .schema-style-notes {
            background-color: #d1ecf1;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        .schema-style-notes h4 {
            margin-top: 0;
            color: #0c5460;
        }
        
        /* Email Scraping Section Styles */
        .email-scraping-section { 
            margin-top: 40px; 
            text-align: left; 
            border-top: 2px solid #f0f0f0; 
            padding-top: 30px; 
        }
        .email-scraping-section h2 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: #333; 
        }
        .email-scraping-section h2::before {
            content: "üìß ";
        }
        #emailScrapingForm input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 16px; 
            box-sizing: border-box; 
            margin-bottom: 10px; 
        }
        #emailScrapingForm button { 
            width: 100%; 
            background-color: #17a2b8; 
            color: white; 
            padding: 12px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
        }
        #emailScrapingForm button:hover { 
            background-color: #138496; 
        }
        #emailScrapingForm button:disabled { 
            background-color: #6c757d; 
            cursor: not-allowed; 
        }
        #emailScrapingResults { 
            margin-top: 20px; 
        }
        
        /* Loading Animation */
        .scraping-loading {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #17a2b8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .scraping-progress {
            color: #17a2b8;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .scraping-status {
            color: #6c757d;
            font-style: italic;
        }
        
        /* Real-time Progress Updates */
        .progress-updates {
            max-height: 300px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .progress-item {
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
            font-size: 14px;
        }
        .progress-item:last-child {
            border-bottom: none;
        }
        .progress-item.page-start {
            color: #17a2b8;
        }
        .progress-item.emails-found {
            color: #28a745;
            font-weight: bold;
        }
        .progress-item.page-complete {
            color: #6c757d;
        }
        .progress-item.page-error {
            color: #dc3545;
        }
        .progress-item.page-blocked {
            color: #ffc107;
        }
        .progress-item.url-filtered {
            color: #6c757d;
        }
        .progress-item.complete {
            color: #28a745;
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            font-weight: bold;
        }
        .progress-stats {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            color: #1976d2;
        }
        
        /* Enhanced Email Results with Personal Data */
        .email-results {
            margin-top: 20px;
        }
        .email-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .email-table th {
            background-color: #17a2b8;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        .email-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .email-table tr:hover {
            background-color: #f8f9fa;
        }
        .email-table tr:last-child td {
            border-bottom: none;
        }
        .email-count {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            color: #1976d2;
        }
        .no-emails {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
        .scraping-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* Personal Data Display Styles */
        .personal-data-section {
            margin-top: 30px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        .personal-data-header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.2em;
            font-weight: bold;
        }
        .personal-data-header::before {
            content: "üë§ ";
        }
        .contact-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #17a2b8;
        }
        .contact-email {
            font-size: 1.1em;
            font-weight: bold;
            color: #17a2b8;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .contact-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .data-section {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            border-left: 3px solid #28a745;
        }
        .data-section h4 {
            margin: 0 0 8px 0;
            color: #155724;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-section.names h4::before { content: "üë§ "; }
        .data-section.addresses h4::before { content: "üè† "; }
        .data-section.jobs h4::before { content: "üíº "; }
        .data-section.companies h4::before { content: "üè¢ "; }
        .data-section.social h4::before { content: "üåê "; }
        .data-section.source h4::before { content: "üìç "; }
        .data-section.industries h4::before { content: "üè≠ "; }
        .data-section.seniority h4::before { content: "üìà "; }
        .data-section.departments h4::before { content: "üè¢ "; }
        .data-section.keywords h4::before { content: "üè∑Ô∏è "; }
        
        .data-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .data-list li {
            padding: 4px 0;
            color: #333;
            font-size: 0.9em;
        }
        .data-list li:not(:last-child) {
            border-bottom: 1px solid #e9ecef;
        }
        .social-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .social-link {
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            text-decoration: none;
            display: inline-block;
        }
        .social-link:hover {
            background-color: #0056b3;
            color: white;
        }
        .social-link.linkedin { background-color: #0077b5; }
        .social-link.twitter { background-color: #1da1f2; }
        .social-link.facebook { background-color: #4267b2; }
        .social-link.instagram { background-color: #e4405f; }
        .social-link.youtube { background-color: #ff0000; }
        
        .data-summary {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .stat-item {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #17a2b8;
        }
        .stat-label {
            font-size: 0.8em;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .no-personal-data {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
            background-color: white;
            border-radius: 5px;
        }
        
        /* Gmail Integration Styles */
        .gmail-section { 
            margin-top: 40px; 
            text-align: left; 
            border-top: 2px solid #f0f0f0; 
            padding-top: 30px; 
        }
        .gmail-section h2 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: #333; 
        }
        .gmail-section h2::before {
            content: "üìß ";
        }
        .gmail-connection {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .gmail-connected {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .gmail-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .connect-gmail-btn {
            background-color: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .connect-gmail-btn:hover {
            background-color: #3367d6;
        }
        .draft-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }
        .draft-form input, .draft-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .draft-form textarea {
            height: 150px;
            resize: vertical;
        }
        .draft-form button {
            width: 100%;
            background-color: #34a853;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .draft-form button:hover {
            background-color: #2d8f47;
        }
        .draft-form button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .gmail-credentials {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 14px;
        }
        .gmail-credentials h4 {
            margin-top: 0;
            color: #856404;
        }
        .gmail-credentials pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        /* Facebook Integration Styles */
        .facebook-section { 
            margin-top: 40px; 
            text-align: left; 
            border-top: 2px solid #f0f0f0; 
            padding-top: 30px; 
        }
        .facebook-section h2 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: #333; 
        }
        .facebook-section h2::before {
            content: "üìò ";
        }

        /* Facebook Status Overview */
        .facebook-status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .status-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .status-info h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .status-info p {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }
        .facebook-connection {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .facebook-connection h3 {
            margin-top: 0;
            color: #856404;
        }

        .facebook-benefits {
            text-align: left;
            max-width: 500px;
            margin: 20px auto;
        }

        .facebook-benefits li {
            margin-bottom: 10px;
            color: #856404;
        }
        .facebook-connected {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .facebook-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .connect-facebook-btn {
            background-color: #4267b2;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .connect-facebook-btn:hover {
            background-color: #365899;
        }
        .facebook-pages {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        .facebook-pages h3 {
            margin-top: 0;
            color: #333;
            margin-bottom: 15px;
        }
        .page-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-info {
            flex: 1;
        }
        .page-name {
            font-weight: bold;
            color: #4267b2;
            margin-bottom: 5px;
        }
        .page-details {
            color: #6c757d;
            font-size: 0.9em;
        }
        .page-actions {
            display: flex;
            gap: 10px;
        }
        .disconnect-page-btn {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .disconnect-page-btn:hover {
            background-color: #c82333;
        }

        /* Facebook Post Form */
        .facebook-post-form {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .char-count {
            text-align: right;
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Facebook Help */
        .facebook-help {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .facebook-help h4 {
            margin-top: 0;
            color: #0056b3;
        }

        .facebook-help ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .facebook-help li {
            margin-bottom: 8px;
            color: #0056b3;
        }
        .facebook-post-form {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }
        .facebook-post-form h3 {
            margin-top: 0;
            color: #333;
            margin-bottom: 15px;
        }
        .facebook-post-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        .facebook-post-form button {
            width: 100%;
            background-color: #4267b2;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .facebook-post-form button:hover {
            background-color: #365899;
        }
        .facebook-post-form button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* Enhanced Facebook Styles */
        .facebook-status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .status-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #4267b2;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-icon {
            font-size: 2em;
        }

        .status-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 14px;
        }

        .status-info p {
            margin: 0;
            color: #666;
            font-weight: 500;
        }

        .facebook-benefits {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .facebook-benefits li {
            padding: 8px 0;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pages-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .facebook-help {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            border-left: 4px solid #17a2b8;
        }

        .facebook-help h4 {
            margin: 0 0 15px 0;
            color: #17a2b8;
        }

        .facebook-help ul {
            margin: 0;
            padding-left: 20px;
        }

        .facebook-help li {
            margin-bottom: 8px;
            color: #555;
        }

        /* Button Styles */
        .btn-secondary {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid #667eea;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #28a745;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .notification.info {
            background-color: #17a2b8;
        }

                  .notification.warning {
              background-color: #ffc107;
              color: #333;
          }
        #postMessage {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        #postMessage.success {
            background-color: #d4edda;
            color: #155724;
        }
        #postMessage.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="welcome">Welcome to Dashboard</div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <div class="dashboard-content">
            <h1 class="dashboard-title">üéâ Dashboard</h1>
            <p class="dashboard-message">You're successfully logged in!</p>
            
            <div class="user-info">
                <p>üë§ <span class="user-email" id="userEmail">Loading...</span></p>
                <p>üÜî User ID: <span id="userId">Loading...</span></p>
            </div>
            
            <!-- Memory & Knowledge Management Section -->
            <div class="dashboard-section">
                <div class="section-header memory" onclick="toggleSection('memory-section')">
                    <div>
                        <span>üß† Memory & Knowledge Management</span>
                        <div class="section-summary">Store, search, and interact with your personal knowledge base</div>
                    </div>
                    <span class="section-toggle collapsed" id="memory-section-toggle">‚ñº</span>
                </div>
                <div class="section-content" id="memory-section-content">
                    <div class="subsection">
                        <h3>Add a New Memory</h3>
                        <form id="memoryForm">
                            <textarea id="memoryContent" placeholder="Type something to remember..."></textarea>
                            <button type="submit">Save to Supermemory</button>
                        </form>
                        <div id="memoryMessage"></div>
                    </div>

                    <div class="subsection">
                        <h3>üîç Search Your Memories</h3>
                        <form id="searchForm">
                            <input type="text" id="searchQuery" placeholder="Search for memories..." required>
                            <button type="submit">üîç Search</button>
                        </form>
                        <div id="searchResults"></div>
                    </div>    

                    <div class="subsection">
                        <h3>ü§ñ Ask AI About Your Memories</h3>
                        <form id="qaForm">
                            <input type="text" id="qaQuery" placeholder="Ask a question about your memories..." required>
                            <button type="submit" id="qaButton">ü§ñ Ask AI</button>
                        </form>
                        <div id="qaResults"></div>
                    </div>
                    
                    <div class="subsection">
                        <h3>‚úâÔ∏è Generate Email Schema from Memory</h3>
                        <p class="section-description">AI analyzes your email writing style from memories and generates email schemas that match your tone and structure.</p>
                        <form id="emailSchemaForm">
                            <input type="text" id="emailSchemaQuery" placeholder="Describe the type of email (e.g., 'professional follow-up', 'friendly reminder')..." required>
                            <button type="submit" id="emailSchemaButton">‚úâÔ∏è Generate Email Schema</button>
                        </form>
                        <div id="emailSchemaResults"></div>
                    </div>
                </div>
            </div>


            <!-- Data Scraping & Collection Section -->
            <div class="dashboard-section">
                <div class="section-header scraping" onclick="toggleSection('scraping-section')">
                    <div>
                        <span>üåê Data Scraping & Collection</span>
                        <div class="section-summary">Extract emails and personal data from websites</div>
                    </div>
                    <span class="section-toggle collapsed" id="scraping-section-toggle">‚ñº</span>
                </div>
                <div class="section-content" id="scraping-section-content">
                    <div class="subsection">
                        <h3>Email & Personal Data Scraper</h3>
                <form id="emailScrapingForm">
                    <textarea id="websiteUrls" placeholder="Enter website URLs to scrape for emails (one URL per line, e.g.:
https://example.com
https://example.org
https://example.net)" required style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; margin-bottom: 15px; resize: vertical;"></textarea>
                    <div style="margin: 15px 0; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="collectPersonalData" checked style="margin-right: 10px; width: 20px; height: 20px;">
                            <span>üîç Collect personal data (names, addresses, social media, job titles)</span>
                        </label>
                        <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">
                            When enabled, the scraper will collect comprehensive contact information beyond just email addresses.
                        </div>
                    </div>
                    <div style="margin: 15px 0; padding: 15px; background-color: #e8f5e8; border-radius: 5px; border: 1px solid #c3e6c3;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="useAICategorization" checked style="margin-right: 10px; width: 20px; height: 20px;">
                            <span>ü§ñ AI-powered data categorization (industries, seniority, departments)</span>
                        </label>
                        <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">
                            Uses Google Gemini Flash via OpenRouter to categorize and enrich contact data with industries, seniority levels, and departments.
                        </div>
                    </div>
                    <div style="margin: 15px 0; padding: 15px; background-color: #eaf0fa; border-radius: 5px; border: 1px solid #bcd0ee;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="restrictToPathEnabled" style="margin-right: 10px; width: 20px; height: 20px;">
                            <span>Restrict scraping to URLs starting with:</span>
                        </label>
                        <input type="text" id="restrictToPath" placeholder="e.g. https://www.intero.com/roster/agents" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.9em; margin-top: 8px;" disabled>
                    </div>
                    <button type="submit" id="scrapeButton">üîç Start Batch Scraping</button>
                </form>
                        <div id="emailScrapingResults"></div>
                    </div>
                    
                    <div class="subsection">
                        <h3>üìÅ Saved CSV Files</h3>
                <div class="csv-files-controls">
                    <button type="button" id="refreshCsvFilesBtn" class="refresh-btn">üîÑ Refresh List</button>
                    <button type="button" id="cleanupOldFilesBtn" class="cleanup-btn">üßπ Clean Up Old Files</button>
                </div>
                        <div id="csvFilesList">
                            <div class="loading">Loading saved CSV files...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Integration Section -->
            <div class="dashboard-section">
                <div class="section-header integrations" onclick="toggleSection('integrations-section')">
                    <div>
                        <span>üìß Email Integration</span>
                        <div class="section-summary">Connect Gmail for email drafting and management</div>
                    </div>
                    <span class="section-toggle collapsed" id="integrations-section-toggle">‚ñº</span>
                </div>
                <div class="section-content" id="integrations-section-content">
                    <div class="subsection">
                        <h3>üìß Gmail Integration</h3>
                <div class="gmail-connection" id="gmailConnection">
                    <h3>Connect Your Gmail Account</h3>
                    <p>Connect your Gmail account to create drafts directly from the dashboard.</p>
                    <a href="#" class="connect-gmail-btn" id="connectGmailBtn">üîó Connect Gmail</a>
                </div>
                
                <div class="draft-form" id="draftForm" style="display: none;">
                    <h3>Create Gmail Draft</h3>
                    <button type="button" id="testGmailBtn" style="background-color: #6c757d; margin-bottom: 15px;">üîß Test Gmail Connection</button>
                    <form id="gmailDraftForm">
                        <input type="email" id="draftTo" placeholder="To: recipient@example.com" required>
                        <input type="text" id="draftSubject" placeholder="Subject" required>
                        <input type="email" id="draftCc" placeholder="CC: cc@example.com (optional)">
                        <input type="email" id="draftBcc" placeholder="BCC: bcc@example.com (optional)">
                        <textarea id="draftBody" placeholder="Email body..." required></textarea>
                        <button type="submit" id="createDraftBtn">üìù Create Draft</button>
                    </form>
                    <div id="draftMessage"></div>
                </div>
            </div>

                </div>
            </div>

            <!-- Social Media Management Section -->
            <div class="dashboard-section">
                <div class="section-header social-media" onclick="toggleSection('social-media-section')">
                    <div>
                        <span>üì± Social Media Management</span>
                        <div class="section-summary">Manage and post to your social media accounts</div>
                    </div>
                    <span class="section-toggle collapsed" id="social-media-section-toggle">‚ñº</span>
                </div>
                <div class="section-content" id="social-media-section-content">
                    <div class="subsection">
                        <h3>üìò Facebook Integration</h3>
                
                <!-- Facebook Status Overview -->
                <div class="facebook-status-overview" id="facebookStatusOverview">
                    <div class="status-card">
                        <div class="status-icon">üìä</div>
                        <div class="status-info">
                            <h4>Connection Status</h4>
                            <p id="connectionStatus">Checking...</p>
                        </div>
                    </div>
                    <div class="status-card">
                        <div class="status-icon">üìÑ</div>
                        <div class="status-info">
                            <h4>Connected Pages</h4>
                            <p id="pagesCount">0 pages</p>
                        </div>
                    </div>
                </div>

                <!-- Facebook Connection -->
                <div class="facebook-connection" id="facebookConnection">
                    <h3>Connect Your Facebook Pages</h3>
                    <p>Connect your Facebook pages to post content directly from the dashboard. You'll be able to:</p>
                    <ul class="facebook-benefits">
                        <li>üì± View all your Facebook pages in one place</li>
                        <li>‚úçÔ∏è Create and schedule posts</li>
                        <li>üìä Monitor page performance</li>
                        <li>üîó Manage page connections</li>
                    </ul>
                    <a href="#" class="connect-facebook-btn" id="connectFacebookBtn">üîó Connect Facebook</a>
                </div>
                
                <!-- Facebook Pages Management -->
                <div class="facebook-pages" id="facebookPages" style="display: none;">
                    <h3>Connected Facebook Pages</h3>
                    <div class="pages-controls">
                        <button id="refreshPagesBtn" class="btn-secondary">üîÑ Refresh Pages</button>
                        <button id="addMorePagesBtn" class="btn-secondary">‚ûï Add More Pages</button>
                    </div>
                    <div id="connectedPagesList">
                        <!-- Connected pages will be displayed here -->
                    </div>
                </div>
                
                <!-- Facebook Posting -->
                <div class="facebook-post-form" id="facebookPostForm" style="display: none;">
                    <h3>Create Facebook Post</h3>
                    <form id="postToFacebookForm">
                        <div class="form-group">
                            <label for="pageSelect">Select Page:</label>
                            <select id="pageSelect" required>
                                <option value="">Select a page to post to...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="postContent">Post Content:</label>
                            <textarea id="postContent" placeholder="What's on your mind?" required style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; margin-bottom: 15px; resize: vertical;"></textarea>
                            <div class="char-count">
                                <span id="charCount">0</span> characters
                            </div>
                        </div>
                        <button type="submit" id="createPostBtn">üìù Post to Facebook</button>
                    </form>
                    <div id="postMessage"></div>
                </div>

                <!-- Facebook Help -->
                <div class="facebook-help">
                    <h4>üí° Need Help?</h4>
                    <p>If you encounter any issues with Facebook integration:</p>
                    <ul>
                        <li>Make sure you're logged into Facebook</li>
                        <li>Check that popups are allowed for this site</li>
                        <li>Ensure your Facebook app has the necessary permissions</li>
                        <li>Try refreshing the page and reconnecting</li>
                    </ul>
                </div>
            </div>
        

                    </div>
                </div>
            </div>

            <div class="back-to-login">
                <a href="index.html">‚Üê Back to Login</a>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect backend URL based on current location
        function getBackendURL() {
            const currentHost = window.location.hostname;
            
            // If accessing from localhost, use localhost for backend
            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                return 'http://localhost:8000/api';
            }
            
            // If accessing from network IP, use the same IP for backend
            return `http://${currentHost}:8000/api`;
        }
        
        const API_URL = getBackendURL(); 

        // Check if user is logged in when page loads
        window.onload = function() {
            // Check if user data exists
            const token = localStorage.getItem('authToken');
            console.log('Token from storage:', token); // Debug line
            
            if (!token) {
                // No user data, redirect to login
                alert('Please login first');
                window.location.href = 'index.html';
                return;
            }
            
            // User is logged in, load dashboard
            loadDashboard();
        };

        // Load dashboard data from backend using JWT token
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('authToken');
                
                if (!token) {
                    // This part is working correctly.
                    throw new Error('No authentication token found in storage.');
                }

                // The 'fetch' call is where the error is.
                // We need to add the 'headers' object to send the token.
                const response = await fetch(`${API_URL}/auth/dashboard`, {
                    method: 'GET',
                    
                    // =======================================================
                    //  ‚úÖ THIS IS THE FIX ‚úÖ
                    //  We must include the 'headers' to send the token.
                    // =======================================================
                    headers: {
                        // This tells the backend we're sending JSON
                        'Content-Type': 'application/json',
                        
                        // This sends the token for authentication
                        // The format "Bearer <token>" is the standard.
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('userEmail').textContent = data.data.user.email;
                    document.getElementById('userId').textContent = data.data.user.id;
                } else {
                    // If the token is invalid or expired, this will now catch it.
                    localStorage.removeItem('authToken');
                    alert('Session invalid or expired. Please login again.');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error in loadDashboard:', error);
                localStorage.removeItem('authToken');
                alert('Could not connect to the server. Please login again.');
                window.location.href = 'index.html';
            }
        }

        // Logout function
        function logout() {
            // Clear JWT token from browser storage
            localStorage.removeItem('authToken');
            
            alert('Logged out successfully!');
            window.location.href = 'index.html';
        }

        document.getElementById('memoryForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent the form from reloading the page

        const contentInput = document.getElementById('memoryContent');
        const content = contentInput.value.trim();
        const token = localStorage.getItem('authToken');
        const messageDiv = document.getElementById('memoryMessage');

        // Clear previous messages
        messageDiv.textContent = '';
        messageDiv.className = '';

        if (!content) {
            messageDiv.textContent = 'Please enter something to remember.';
            messageDiv.className = 'error';
            return;
        }

        if (!token) {
            alert('Your session has expired. Please log in again.');
            window.location.href = 'index.html';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/memories/add`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: content }),
            });

            const result = await response.json();

            if (result.success) {
                messageDiv.textContent = `Success! Memory saved with ID: ${result.data.memoryId}`;
                messageDiv.className = 'success';
                contentInput.value = ''; // Clear the textarea
            } else {
                messageDiv.textContent = `Error: ${result.message}`;
                messageDiv.className = 'error';
            }
        } catch (error) {
            console.error('Error submitting memory:', error);
            messageDiv.textContent = 'An error occurred. Please try again.';
            messageDiv.className = 'error';
        }
    });
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const queryInput = document.getElementById('searchQuery');
        const query = queryInput.value.trim();
        const token = localStorage.getItem('authToken');
        const resultsDiv = document.getElementById('searchResults');

        resultsDiv.innerHTML = '<p>Searching...</p>'; // Show a loading message

        if (!query) {
            resultsDiv.innerHTML = '<p style="color: red;">Please enter a search term.</p>';
            return;
        }

        if (!token) {
            alert('Your session has expired. Please log in again.');
            window.location.href = 'index.html';
            return;
        }

        try {
            const response = await fetch(`${API_URL}/memories/search`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query }),
            });

            const result = await response.json();

            if (result.success && result.data.results.length > 0) {
                // Clear loading message and display results
                resultsDiv.innerHTML = '';
                result.data.results.forEach(item => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'result-item';

                    let chunksHTML = item.chunks.map(chunk => `<p>${chunk.content}</p>`).join('');

                    resultElement.innerHTML = `
                        <h3>${item.title || 'Memory Chunk'}</h3>
                        ${chunksHTML}
                        <p class="score">Relevance Score: ${Math.round(item.score * 100)}%</p>
                    `;
                    resultsDiv.appendChild(resultElement);
                });
            } else if (result.success) {
                resultsDiv.innerHTML = '<p>No results found for your query.</p>';
            } else {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${result.message}</p>`;
            }
        } catch (error) {
            console.error('Error searching memories:', error);
            resultsDiv.innerHTML = '<p style="color: red;">An error occurred. Please try again.</p>';
        }
    });

        // NEW: AI Q&A Form Handler
        document.getElementById('qaForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            const token = localStorage.getItem('authToken');
            const resultsDiv = document.getElementById('qaResults');
            const qaButton = document.getElementById('qaButton');

            if (!question) {
                resultsDiv.innerHTML = '<p style="color: red;">Please enter a question.</p>';
                return;
            }

            if (!token) {
                alert('Your session has expired. Please log in again.');
                window.location.href = 'index.html';
                return;
            }

            // Show loading state
            qaButton.disabled = true;
            qaButton.textContent = 'Thinking...';
            resultsDiv.innerHTML = '<p class="loading">ü§ñ AI is thinking about your question...</p>';

            try {
                const response = await fetch(`${API_URL}/memories/ask`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question }),
                });

                const result = await response.json();

                if (result.success) {
                    // Display the AI answer
                    resultsDiv.innerHTML = `
                        <div class="qa-item">
                            <div class="qa-question">‚ùì ${result.data.question}</div>
                            <div class="qa-answer">ü§ñ ${result.data.answer}</div>
                        </div>
                    `;
                    
                    // Clear the input
                    questionInput.value = '';
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error asking AI question:', error);
                resultsDiv.innerHTML = '<p style="color: red;">An error occurred. Please try again.</p>';
            } finally {
                // Reset button state
                qaButton.disabled = false;
                qaButton.textContent = 'Ask AI';
            }
        });

        // Email Schema Form Handler
        document.getElementById('emailSchemaForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const promptInput = document.getElementById('emailSchemaPrompt');
            const prompt = promptInput.value.trim();
            const token = localStorage.getItem('authToken');
            const resultsDiv = document.getElementById('emailSchemaResults');
            const generateBtn = document.getElementById('generateSchemaBtn');

            if (!prompt) {
                resultsDiv.innerHTML = '<p style="color: red;">Please enter a description of the email you want to generate.</p>';
                return;
            }

            if (!token) {
                alert('Your session has expired. Please log in again.');
                window.location.href = 'index.html';
                return;
            }

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = 'üéØ Analyzing your style...';
            resultsDiv.innerHTML = '<p class="loading">ü§ñ AI is analyzing your email writing style from memories...</p>';

            try {
                const response = await fetch(`${API_URL}/memories/generate-email-schema`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: prompt }),
                });

                const result = await response.json();

                if (result.success) {
                    const schema = result.data.schema;
                    
                    // Display the email schema
                    resultsDiv.innerHTML = `
                        <div class="schema-item">
                            <div class="schema-header">
                                <div class="schema-subject">üìß ${schema.subject}</div>
                                <div class="schema-tone">${schema.tone}</div>
                            </div>
                            <div class="schema-body">${schema.body}</div>
                            <div class="schema-details">
                                <div class="schema-key-points">
                                    <h4>üéØ Key Points</h4>
                                    <ul>
                                        ${schema.keyPoints.map(point => `<li>${point}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="schema-style-notes">
                                    <h4>üìù Style Notes</h4>
                                    <p>${schema.styleNotes}</p>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background-color: #e8f5e8; border-radius: 5px; color: #155724;">
                                <strong>Structure:</strong> ${schema.structure}
                            </div>
                        </div>
                    `;
                    
                    // Clear the input
                    promptInput.value = '';
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error generating email schema:', error);
                resultsDiv.innerHTML = '<p style="color: red;">An error occurred. Please try again.</p>';
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                generateBtn.textContent = 'üéØ Generate Email Schema';
            }
        });

        // Email Scraping Form Handler
        document.getElementById('emailScrapingForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const urlsInput = document.getElementById('websiteUrls');
            const urlsText = urlsInput.value.trim();
            const resultsDiv = document.getElementById('emailScrapingResults');
            const scrapeButton = document.getElementById('scrapeButton');

            if (!urlsText) {
                resultsDiv.innerHTML = '<p style="color: red;">Please enter at least one website URL.</p>';
                return;
            }

            // Parse URLs from textarea (one per line)
            const urls = urlsText.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);

            if (urls.length === 0) {
                resultsDiv.innerHTML = '<p style="color: red;">Please enter at least one valid website URL.</p>';
                return;
            }

            if (urls.length > 100) {
                resultsDiv.innerHTML = '<p style="color: red;">Maximum 100 URLs allowed per batch. Please reduce the number of URLs.</p>';
                return;
            }

            // Show loading state
            scrapeButton.disabled = true;
            scrapeButton.textContent = 'üîÑ Batch Scraping...';
            
            // Initialize progress tracking
            let progressUpdates = [];
            let currentStats = {
                totalUrls: urls.length,
                completedUrls: 0,
                successfulUrls: 0,
                failedUrls: 0,
                totalEmails: 0,
                totalPages: 0
            };
            
            // Show initial loading animation
            resultsDiv.innerHTML = `
                <div class="scraping-loading">
                    <div class="spinner"></div>
                    <div class="scraping-progress">üîç Starting batch email scraping...</div>
                    <div class="scraping-status">Processing ${urls.length} URLs</div>
                </div>
                <div class="progress-updates" id="progressUpdates">
                    <div class="progress-stats" id="progressStats">
                        üåê URLs: 0/${urls.length} | üìß Emails: 0 | üìä Pages: 0
                    </div>
                </div>
            `;

            try {
                // Get personal data collection preference
                const collectPersonalData = document.getElementById('collectPersonalData').checked;
                const useAICategorization = document.getElementById('useAICategorization').checked;
                
                // Get restrictToPath preference
                const restrictToPathEnabled = document.getElementById('restrictToPathEnabled').checked;
                const restrictToPath = restrictToPathEnabled ? document.getElementById('restrictToPath').value.trim() : '';
                
                // Send the request to batch endpoint
                const response = await fetch(`${SCRAPER_URL}/api/scrape/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        urls: urls,
                        options: {
                            collectPersonalData: collectPersonalData,
                            useAICategorization: useAICategorization,
                            restrictToPath: restrictToPath
                        }
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    // Display batch results
                    displayBatchResults(data.data, urls);
                } else {
                    throw new Error(data.error || 'Batch scraping failed');
                }

            } catch (error) {
                console.error('Error batch scraping emails:', error);
                resultsDiv.innerHTML = `
                    <div class="scraping-error">
                        ‚ùå Error: ${error.message || 'Could not connect to the scraper service. Make sure the scraper is running on port 3001.'}
                    </div>
                `;
            } finally {
                // Reset button state
                scrapeButton.disabled = false;
                scrapeButton.textContent = 'üîç Start Batch Scraping';
            }
        });

        // Handle real-time progress updates
        function handleProgressUpdate(data, progressUpdates, currentStats, resultsDiv) {
            const progressUpdatesDiv = document.getElementById('progressUpdates');
            const progressStatsDiv = document.getElementById('progressStats');
            
            if (!progressUpdatesDiv || !progressStatsDiv) return;

            switch (data.type) {
                case 'page_start':
                    progressUpdates.push({
                        type: 'page-start',
                        message: `üîç Starting to scrape: ${data.url} (depth: ${data.depth})`
                    });
                    break;
                    
                case 'emails_found':
                    let personalDataInfo = '';
                                            if (data.personalData) {
                            const personalStats = {
                                names: data.personalData.names ? data.personalData.names.length : 0,
                                keywords: data.personalData.keywords ? data.personalData.keywords.length : 0,
                                addresses: data.personalData.addresses ? data.personalData.addresses.length : 0,
                                social: data.personalData.socialMedia ? Object.keys(data.personalData.socialMedia).length : 0,
                                industries: data.personalData.industries ? data.personalData.industries.length : 0,
                                seniority: data.personalData.seniority ? data.personalData.seniority.length : 0
                            };
                            personalDataInfo = ` | üë§ ${personalStats.names} names, üè∑Ô∏è ${personalStats.keywords} keywords, üè† ${personalStats.addresses} addresses, üåê ${personalStats.social} social profiles`;
                        if (personalStats.industries > 0 || personalStats.seniority > 0) {
                            personalDataInfo += `, ü§ñ AI: ${personalStats.industries} industries, ${personalStats.seniority} seniority levels`;
                        }
                    }
                    
                    progressUpdates.push({
                        type: 'emails-found',
                        message: `üìß Found ${data.emails.length} email(s) on ${data.url}: ${data.emails.join(', ')}${personalDataInfo}`
                    });
                    currentStats.emailsFound += data.emails.length;
                    currentStats.totalEmails = data.totalEmails;
                    break;
                    
                case 'page_complete':
                    progressUpdates.push({
                        type: 'page-complete',
                        message: `‚úÖ Completed: ${data.url} (${data.emailsFound} emails found)`
                    });
                    currentStats.pagesVisited = data.pagesVisited;
                    break;
                    
                case 'page_error':
                    progressUpdates.push({
                        type: 'page-error',
                        message: `‚ùå Error scraping ${data.url}: ${data.error}`
                    });
                    break;
                    
                case 'page_blocked':
                    progressUpdates.push({
                        type: 'page-blocked',
                        message: `üö´ Blocked by robots.txt: ${data.url}`
                    });
                    break;
                    
                case 'url_filtered':
                    progressUpdates.push({
                        type: 'url-filtered',
                        message: `üö´ Skipped ${data.url}: ${data.reason}`
                    });
                    break;
                    
                case 'complete':
                    console.log('Scraping completed, displaying results:', data);
                    // Add completion message to progress
                    progressUpdates.push({
                        type: 'complete',
                        message: `üéâ Scraping completed! Found ${data.data.totalEmails} emails from ${data.data.pagesVisited} pages`
                    });
                    // Show final results
                    displayEmailResults(data.data);
                    // Re-enable the form
                    document.getElementById('scrapeButton').disabled = false;
                    document.getElementById('scrapeButton').textContent = 'üîç Start Scraping';
                    return;
                    
                case 'error':
                    console.log('Scraping error:', data);
                    resultsDiv.innerHTML = `
                        <div class="scraping-error">
                            ‚ùå Error: ${data.error || data.message || 'Failed to scrape emails'}
                        </div>
                    `;
                    // Re-enable the form
                    document.getElementById('scrapeButton').disabled = false;
                    document.getElementById('scrapeButton').textContent = 'üîç Start Scraping';
                    return;
            }

            // Update progress display
            progressStatsDiv.innerHTML = `üìä Pages: ${currentStats.pagesVisited} | üìß Emails: ${currentStats.totalEmails}`;
            
            // Update progress list (keep last 20 items)
            const recentUpdates = progressUpdates.slice(-20);
            progressUpdatesDiv.innerHTML = `
                <div class="progress-stats" id="progressStats">
                    üìä Pages: ${currentStats.pagesVisited} | üìß Emails: ${currentStats.totalEmails}
                </div>
                ${recentUpdates.map(update => `
                    <div class="progress-item ${update.type}">
                        ${update.message}
                    </div>
                `).join('')}
            `;
            
            // Auto-scroll to bottom
            progressUpdatesDiv.scrollTop = progressUpdatesDiv.scrollHeight;
        }

        // Function to display email results with personal data
        function displayEmailResults(data) {
            const resultsDiv = document.getElementById('emailScrapingResults');
            
            if (!data.emails || data.emails.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="email-results">
                        <div class="no-emails">
                            üì≠ No emails found on ${data.url}
                        </div>
                        <div style="text-align: center; margin-top: 10px; color: #6c757d;">
                            Pages visited: ${data.pagesVisited || 0}
                        </div>
                    </div>
                `;
                return;
            }

            // Create table rows for emails
            const emailRows = data.emails.map((email, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${email}</td>
                    <td>${data.url}</td>
                    <td>${new Date(data.timestamp).toLocaleString()}</td>
                </tr>
            `).join('');

            let personalDataSection = '';
            
            // Check if personal data is available
            if (data.personalData && Object.keys(data.personalData).length > 0) {
                personalDataSection = generatePersonalDataSection(data.personalData);
            }

            resultsDiv.innerHTML = `
                <div class="email-results">
                    <div class="email-count">
                        üìß Found ${data.totalEmails} email(s) on ${data.url}
                    </div>
                    <table class="email-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Email Address</th>
                                <th>Source URL</th>
                                <th>Scraped At</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${emailRows}
                        </tbody>
                    </table>
                    <div style="text-align: center; margin-top: 15px; color: #6c757d;">
                        Pages visited: ${data.pagesVisited || 0} | Mode: ${data.mode || 'standard'}
                    </div>
                    ${personalDataSection}
                </div>
            `;
        }

        // Function to display batch scraping results
        function displayBatchResults(data, originalUrls) {
            const resultsDiv = document.getElementById('emailScrapingResults');
            
            // Calculate summary statistics
            const successfulResults = data.results.filter(r => r.success);
            const failedResults = data.results.filter(r => !r.success);
            const allEmails = [];
            const allPersonalData = {};
            let totalPages = 0;

            // Collect all emails and personal data from successful results
            successfulResults.forEach(result => {
                if (result.emails) {
                    allEmails.push(...result.emails);
                }
                if (result.personalData) {
                    Object.assign(allPersonalData, result.personalData);
                }
                totalPages += result.pagesVisited || 0;
            });

            // Create summary section
            const summarySection = `
                <div class="batch-summary">
                    <h3>üìä Batch Scraping Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number">${data.totalUrls}</div>
                            <div class="stat-label">Total URLs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${data.successfulUrls}</div>
                            <div class="stat-label">Successful</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${data.failedUrls}</div>
                            <div class="stat-label">Failed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${data.totalEmails}</div>
                            <div class="stat-label">Total Emails</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${totalPages}</div>
                            <div class="stat-label">Total Pages</div>
                        </div>
                    </div>
                </div>
            `;

            // Create results table
            const resultsTable = `
                <div class="batch-results">
                    <h3>üåê Individual URL Results</h3>
                    <table class="batch-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>URL</th>
                                <th>Status</th>
                                <th>Emails Found</th>
                                <th>Pages Visited</th>
                                <th>Error (if any)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.results.map((result, index) => `
                                <tr class="${result.success ? 'success-row' : 'error-row'}">
                                    <td>${index + 1}</td>
                                    <td>${result.url}</td>
                                    <td>
                                        <span class="status-badge ${result.success ? 'success' : 'error'}">
                                            ${result.success ? '‚úÖ Success' : '‚ùå Failed'}
                                        </span>
                                    </td>
                                    <td>${result.success ? (result.totalEmails || 0) : '-'}</td>
                                    <td>${result.success ? (result.pagesVisited || 0) : '-'}</td>
                                    <td>${result.success ? '-' : result.error}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Create combined emails table if any emails were found
            let emailsSection = '';
            if (allEmails.length > 0) {
                const emailRows = allEmails.map((email, index) => {
                    // Find which URL this email came from
                    const sourceUrl = successfulResults.find(result => 
                        result.emails && result.emails.includes(email)
                    )?.url || 'Unknown';
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${email}</td>
                            <td>${sourceUrl}</td>
                            <td>${new Date(data.timestamp).toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');

                emailsSection = `
                    <div class="combined-emails">
                        <h3>üìß All Emails Found (${allEmails.length})</h3>
                        <table class="email-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Email Address</th>
                                    <th>Source URL</th>
                                    <th>Scraped At</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${emailRows}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Create personal data section if any personal data was found
            let personalDataSection = '';
            if (Object.keys(allPersonalData).length > 0) {
                personalDataSection = generatePersonalDataSection(allPersonalData);
            }

            // Combine all sections
            resultsDiv.innerHTML = `
                <div class="batch-email-results">
                    ${summarySection}
                    ${resultsTable}
                    ${emailsSection}
                    ${personalDataSection}
                    ${allEmails.length > 0 ? `
                        <div class="export-section">
                            <h3>üíæ Export Results</h3>
                            <button type="button" id="exportCsvBtn" class="export-btn">
                                üìÑ Export to CSV
                            </button>
                            <div class="export-info">
                                Export ${allEmails.length} emails with personal data to CSV file
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Add event listener for CSV export if emails were found
            if (allEmails.length > 0) {
                document.getElementById('exportCsvBtn').addEventListener('click', function() {
                    exportToCSV(data, originalUrls);
                });
            }
        }

        // Function to generate personal data section
        function generatePersonalDataSection(personalData) {
            const emails = Object.keys(personalData);
            
            if (emails.length === 0) {
                return `
                    <div class="personal-data-section">
                        <div class="no-personal-data">
                            üì≠ No personal data found for the scraped emails
                        </div>
                    </div>
                `;
            }

            // Calculate summary statistics
            const summary = calculatePersonalDataSummary(personalData);
            
            // Generate contact cards
            const contactCards = emails.map(email => generateContactCard(email, personalData[email])).join('');

            return `
                <div class="personal-data-section">
                    <div class="personal-data-header">Personal Data Collected</div>
                    
                    <div class="data-summary">
                        <div>üìä Data Summary</div>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <div class="stat-number">${summary.totalContacts}</div>
                                <div class="stat-label">Contacts</div>
                            </div>
                                                    <div class="stat-item">
                            <div class="stat-number">${summary.totalNames}</div>
                            <div class="stat-label">Names</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${summary.totalKeywords}</div>
                            <div class="stat-label">Keywords</div>
                        </div>
                            <div class="stat-item">
                                <div class="stat-number">${summary.totalAddresses}</div>
                                <div class="stat-label">Addresses</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${summary.totalSocialProfiles}</div>
                                <div class="stat-label">Social Profiles</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${summary.totalJobTitles}</div>
                                <div class="stat-label">Job Titles</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${summary.totalIndustries}</div>
                                <div class="stat-label">Industries</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${summary.totalSeniority}</div>
                                <div class="stat-label">Seniority</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${summary.totalDepartments}</div>
                                <div class="stat-label">Departments</div>
                            </div>
                        </div>
                    </div>
                    
                    ${contactCards}
                </div>
            `;
        }

        // Function to calculate personal data summary
        function calculatePersonalDataSummary(personalData) {
            const emails = Object.keys(personalData);
            let totalNames = 0;
            let totalKeywords = 0;
            let totalAddresses = 0;
            let totalSocialProfiles = 0;
            let totalJobTitles = 0;
            let totalCompanies = 0;
            let totalIndustries = 0;
            let totalSeniority = 0;
            let totalDepartments = 0;

            emails.forEach(email => {
                const data = personalData[email];
                totalNames += data.names ? data.names.length : 0;
                totalKeywords += data.keywords ? data.keywords.length : 0;
                totalAddresses += data.addresses ? data.addresses.length : 0;
                totalJobTitles += data.jobTitles ? data.jobTitles.length : 0;
                totalCompanies += data.companies ? data.companies.length : 0;
                totalIndustries += data.industries ? data.industries.length : 0;
                totalSeniority += data.seniority ? data.seniority.length : 0;
                totalDepartments += data.departments ? data.departments.length : 0;
                
                if (data.socialMedia) {
                    Object.values(data.socialMedia).forEach(profiles => {
                        totalSocialProfiles += profiles.length;
                    });
                }
            });

            return {
                totalContacts: emails.length,
                totalNames,
                totalKeywords,
                totalAddresses,
                totalSocialProfiles,
                totalJobTitles,
                totalCompanies,
                totalIndustries,
                totalSeniority,
                totalDepartments
            };
        }

        // Function to generate individual contact card
        function generateContactCard(email, data) {
            const sections = [];

            // Names section
            if (data.names && data.names.length > 0) {
                sections.push(`
                    <div class="data-section names">
                        <h4>Names</h4>
                        <ul class="data-list">
                            ${data.names.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Keywords section
            if (data.keywords && data.keywords.length > 0) {
                sections.push(`
                    <div class="data-section keywords">
                        <h4>Keywords</h4>
                        <ul class="data-list">
                            ${data.keywords.slice(0, 30).map(keyword => `<li>${keyword}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Industries section (AI-categorized)
            if (data.industries && data.industries.length > 0) {
                sections.push(`
                    <div class="data-section industries">
                        <h4>Industries</h4>
                        <ul class="data-list">
                            ${data.industries.map(industry => `<li>${industry}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Seniority section (AI-categorized)
            if (data.seniority && data.seniority.length > 0) {
                sections.push(`
                    <div class="data-section seniority">
                        <h4>Seniority</h4>
                        <ul class="data-list">
                            ${data.seniority.map(level => `<li>${level}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Departments section (AI-categorized)
            if (data.departments && data.departments.length > 0) {
                sections.push(`
                    <div class="data-section departments">
                        <h4>Departments</h4>
                        <ul class="data-list">
                            ${data.departments.map(dept => `<li>${dept}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Addresses section
            if (data.addresses && data.addresses.length > 0) {
                sections.push(`
                    <div class="data-section addresses">
                        <h4>Addresses</h4>
                        <ul class="data-list">
                            ${data.addresses.map(address => `<li>${address}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Job titles section
            if (data.jobTitles && data.jobTitles.length > 0) {
                sections.push(`
                    <div class="data-section jobs">
                        <h4>Job Titles</h4>
                        <ul class="data-list">
                            ${data.jobTitles.map(title => `<li>${title}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Companies section
            if (data.companies && data.companies.length > 0) {
                sections.push(`
                    <div class="data-section companies">
                        <h4>Companies</h4>
                        <ul class="data-list">
                            ${data.companies.map(company => `<li>${company}</li>`).join('')}
                        </ul>
                    </div>
                `);
            }

            // Social media section
            if (data.socialMedia && Object.keys(data.socialMedia).length > 0) {
                const socialLinks = [];
                Object.entries(data.socialMedia).forEach(([platform, profiles]) => {
                    profiles.forEach(profile => {
                        const platformClass = platform.toLowerCase();
                        socialLinks.push(`
                            <a href="https://${profile}" target="_blank" class="social-link ${platformClass}">
                                ${platform} - ${profile.split('/').pop()}
                            </a>
                        `);
                    });
                });

                if (socialLinks.length > 0) {
                    sections.push(`
                        <div class="data-section social">
                            <h4>Social Media</h4>
                            <div class="social-links">
                                ${socialLinks.join('')}
                            </div>
                        </div>
                    `);
                }
            }

            // Source URL section
            if (data.sourceUrl) {
                sections.push(`
                    <div class="data-section source">
                        <h4>Source</h4>
                        <ul class="data-list">
                            <li><a href="${data.sourceUrl}" target="_blank">${data.sourceUrl}</a></li>
                        </ul>
                    </div>
                `);
            }

            return `
                <div class="contact-card">
                    <div class="contact-email">üìß ${email}</div>
                    <div class="contact-data-grid">
                        ${sections.join('')}
                    </div>
                </div>
            `;
        }

        // Gmail Integration
        let gmailConnected = false;

        // Check Gmail connection status on page load
        async function checkGmailConnection() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/gmail/check`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success && result.data.connected) {
                    gmailConnected = true;
                    showGmailConnected();
                } else {
                    gmailConnected = false;
                    showGmailDisconnected();
                }
            } catch (error) {
                console.error('Error checking Gmail connection:', error);
                gmailConnected = false;
                showGmailDisconnected();
            }
        }

        // Connect Gmail button handler
        document.getElementById('connectGmailBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please login first');
                return;
            }

            try {
                // Get Gmail OAuth URL
                const response = await fetch(`${API_URL}/gmail/auth/url`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                console.log('--- Frontend Facebook Auth Debug ---');
                console.log('API URL:', API_URL);
                console.log('Token:', token ? token.substring(0, 20) + '...' : 'null');
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Response result:', result);

                if (result.success) {
                    // Open Gmail OAuth in a new window
                    const authWindow = window.open(result.data.authUrl, 'gmail-auth', 'width=500,height=600');
                    
                    // Listen for the callback
                    window.addEventListener('message', async function(event) {
                        if (event.origin !== window.location.origin) return;
                        
                        if (event.data.type === 'gmail-auth-success') {
                            gmailConnected = true;
                            showGmailConnected();
                            if (authWindow) authWindow.close();
                        }
                    });
                } else {
                    alert('Failed to get Gmail authorization URL');
                }
            } catch (error) {
                console.error('Error connecting Gmail:', error);
                alert('Failed to connect Gmail');
            }
        });

        // Show Gmail connected state
        function showGmailConnected() {
            const connectionDiv = document.getElementById('gmailConnection');
            const draftForm = document.getElementById('draftForm');
            
            connectionDiv.innerHTML = `
                <div class="gmail-connected">
                    <h3>‚úÖ Gmail Connected Successfully!</h3>
                    <p>Your Gmail account is connected and credentials are stored securely.</p>
                    <button type="button" id="disconnectGmailBtn" style="background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        üîå Disconnect Gmail
                    </button>
                </div>
            `;
            
            draftForm.style.display = 'block';
            
            // Add disconnect button handler
            document.getElementById('disconnectGmailBtn').addEventListener('click', disconnectGmail);
        }

        // Show Gmail disconnected state
        function showGmailDisconnected() {
            const connectionDiv = document.getElementById('gmailConnection');
            const draftForm = document.getElementById('draftForm');
            
            connectionDiv.innerHTML = `
                <div class="gmail-disconnected">
                    <h3>Connect Your Gmail Account</h3>
                    <p>Connect your Gmail account to create drafts directly from the dashboard.</p>
                    <a href="#" class="connect-gmail-btn" id="connectGmailBtn">üîó Connect Gmail</a>
                </div>
            `;
            
            draftForm.style.display = 'none';
            
            // Re-add connect button handler
            document.getElementById('connectGmailBtn').addEventListener('click', async function(e) {
                e.preventDefault();
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please login first');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/gmail/auth/url`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const authWindow = window.open(result.data.authUrl, 'gmail-auth', 'width=500,height=600');
                        
                        window.addEventListener('message', async function(event) {
                            if (event.origin !== window.location.origin) return;
                            
                            if (event.data.type === 'gmail-auth-success') {
                                gmailConnected = true;
                                showGmailConnected();
                                if (authWindow) authWindow.close();
                            }
                        });
                    } else {
                        alert('Failed to get Gmail authorization URL');
                    }
                } catch (error) {
                    console.error('Error connecting Gmail:', error);
                    alert('Failed to connect Gmail');
                }
            });
        }

        // Disconnect Gmail function
        async function disconnectGmail() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/gmail/disconnect`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    gmailConnected = false;
                    showGmailDisconnected();
                    alert('Gmail disconnected successfully');
                } else {
                    alert('Failed to disconnect Gmail');
                }
            } catch (error) {
                console.error('Error disconnecting Gmail:', error);
                alert('Failed to disconnect Gmail');
            }
        }

        // Test Gmail Connection Button Handler
        document.getElementById('testGmailBtn').addEventListener('click', async function() {
            if (!gmailConnected) {
                alert('Please connect your Gmail account first');
                return;
            }

            const testBtn = document.getElementById('testGmailBtn');
            const messageDiv = document.getElementById('draftMessage');

            testBtn.disabled = true;
            testBtn.textContent = 'üîß Testing...';
            messageDiv.innerHTML = '';

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/gmail/test`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `
                        <div class="gmail-connected">
                            ‚úÖ Gmail connection test successful!<br>
                            Email: ${result.data.profile.emailAddress}<br>
                            Messages Total: ${result.data.profile.messagesTotal}
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `<p style="color: red;">‚ùå Connection test failed: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error testing Gmail connection:', error);
                messageDiv.innerHTML = '<p style="color: red;">‚ùå Failed to test connection. Please try again.</p>';
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'üîß Test Gmail Connection';
            }
        });

        // Gmail Draft Form Handler
        document.getElementById('gmailDraftForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!gmailConnected) {
                alert('Please connect your Gmail account first');
                return;
            }

            const to = document.getElementById('draftTo').value.trim();
            const subject = document.getElementById('draftSubject').value.trim();
            const body = document.getElementById('draftBody').value.trim();
            const cc = document.getElementById('draftCc').value.trim();
            const bcc = document.getElementById('draftBcc').value.trim();
            const createBtn = document.getElementById('createDraftBtn');
            const messageDiv = document.getElementById('draftMessage');

            if (!to || !subject || !body) {
                messageDiv.innerHTML = '<p style="color: red;">Please fill in all required fields.</p>';
                return;
            }

            // Show loading state
            createBtn.disabled = true;
            createBtn.textContent = 'üìù Creating Draft...';
            messageDiv.innerHTML = '';

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/gmail/drafts/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to,
                        subject,
                        body,
                        cc: cc || undefined,
                        bcc: bcc || undefined
                    }),
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `
                        <div class="gmail-connected">
                            ‚úÖ Draft created successfully!<br>
                            Draft ID: ${result.data.draftId}<br>
                            <a href="https://mail.google.com/mail/u/0/#drafts" target="_blank" style="color: #155724;">
                                üìß Open Gmail Drafts
                            </a>
                        </div>
                    `;
                    
                    // Clear form
                    document.getElementById('gmailDraftForm').reset();
                } else {
                    messageDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error creating draft:', error);
                messageDiv.innerHTML = '<p style="color: red;">‚ùå Failed to create draft. Please try again.</p>';
            } finally {
                // Reset button state
                createBtn.disabled = false;
                createBtn.textContent = 'üìù Create Draft';
            }
        });

        // Notification System
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Facebook Integration
        let facebookConnected = false;

        // Check Facebook connection status on page load
        async function checkFacebookConnection() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/facebook/pages`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success && result.data.pages && result.data.pages.length > 0) {
                    facebookConnected = true;
                    showFacebookConnected();
                    loadConnectedPages();
                } else {
                    facebookConnected = false;
                    showFacebookDisconnected();
                }
            } catch (error) {
                console.error('Error checking Facebook connection:', error);
                facebookConnected = false;
                showFacebookDisconnected();
                updateFacebookStatus(false, 0);
            }
        }



        // Connect Facebook button handler
        document.getElementById('connectFacebookBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please login first');
                return;
            }

            try {
                // Show loading state
                const connectBtn = document.getElementById('connectFacebookBtn');
                const originalText = connectBtn.textContent;
                connectBtn.textContent = 'üîÑ Connecting...';
                connectBtn.disabled = true;

                // Get Facebook OAuth URL
                const response = await fetch(`${API_URL}/facebook/auth/url`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                console.log('--- Frontend Facebook Auth Debug ---');
                console.log('API URL:', API_URL);
                console.log('Token:', token ? token.substring(0, 20) + '...' : 'null');
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Response result:', result);

                if (result.success) {
                    // Open Facebook OAuth in a new window (JWT token is now encoded in state parameter)
                    const authWindow = window.open(result.data.authUrl, 'facebook-auth', 'width=500,height=600');
                    
                    if (!authWindow) {
                        throw new Error('Popup blocked! Please allow popups for this site.');
                    }

                    // Listen for the callback
                    const messageHandler = async function(event) {
                        if (event.origin !== window.location.origin) return;
                        
                        if (event.data.type === 'facebook-auth-success') {
                            window.removeEventListener('message', messageHandler);
                            facebookConnected = true;
                            showFacebookConnected();
                            loadConnectedPages();
                            if (authWindow) authWindow.close();
                            
                            // Show success message
                            showNotification('Facebook connected successfully!', 'success');
                            
                            // Persist user access token if provided
                            if (event.data.access_token) {
                                try {
                                    localStorage.setItem('fbUserAccessToken', event.data.access_token);
                                    const meResp = await fetch(`https://graph.facebook.com/v18.0/me?fields=id,name&access_token=${encodeURIComponent(event.data.access_token)}`);
                                    const me = await meResp.json();
                                    console.log('Verified Facebook /me:', me);
                                } catch (e) {
                                    console.warn('Failed to verify /me after connect:', e);
                                }
                            }
                        } else if (event.data.type === 'facebook-auth-error') {
                            window.removeEventListener('message', messageHandler);
                            if (authWindow) authWindow.close();
                            showNotification('Facebook connection failed: ' + event.data.error, 'error');
                        }
                    };

                    window.addEventListener('message', messageHandler);

                    // Check if window was closed manually
                    const checkClosed = setInterval(() => {
                        if (authWindow.closed) {
                            clearInterval(checkClosed);
                            window.removeEventListener('message', messageHandler);
                            // Reset button state
                            connectBtn.textContent = originalText;
                            connectBtn.disabled = false;
                        }
                    }, 1000);

                } else {
                    throw new Error(result.message || 'Failed to get Facebook authorization URL');
                }
            } catch (error) {
                console.error('Error connecting Facebook:', error);
                showNotification('Failed to connect Facebook: ' + error.message, 'error');
            } finally {
                // Reset button state
                const connectBtn = document.getElementById('connectFacebookBtn');
                connectBtn.textContent = originalText;
                connectBtn.disabled = false;
            }
        });

        // Show Facebook connected state
        function showFacebookConnected() {
            const connectionDiv = document.getElementById('facebookConnection');
            const pagesDiv = document.getElementById('facebookPages');
            const postForm = document.getElementById('facebookPostForm');
            
            connectionDiv.innerHTML = `
                <div class="facebook-connected">
                    <h3>‚úÖ Facebook Connected Successfully!</h3>
                    <p>Your Facebook pages are connected and ready for posting.</p>
                    <button type="button" id="disconnectFacebookBtn" style="background-color: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        üîå Disconnect Facebook
                    </button>
                </div>
            `;
            
            pagesDiv.style.display = 'block';
            postForm.style.display = 'block';
            
            // Add disconnect button handler
            document.getElementById('disconnectFacebookBtn').addEventListener('click', disconnectFacebook);
            
            // Add event listeners for new features
            addFacebookEventListeners();
        }

        // Show Facebook disconnected state
        function showFacebookDisconnected() {
            const connectionDiv = document.getElementById('facebookConnection');
            const pagesDiv = document.getElementById('facebookPages');
            const postForm = document.getElementById('facebookPostForm');
            
            connectionDiv.innerHTML = `
                <div class="facebook-disconnected">
                    <h3>Connect Your Facebook Pages</h3>
                    <p>Connect your Facebook pages to post content directly from the dashboard.</p>
                    <a href="#" class="connect-facebook-btn" id="connectFacebookBtn">üîó Connect Facebook</a>
                </div>
            `;
            
            pagesDiv.style.display = 'none';
            postForm.style.display = 'none';
            
            // Re-add connect button handler
            document.getElementById('connectFacebookBtn').addEventListener('click', async function(e) {
                e.preventDefault();
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please login first');
                    return;
                }

                try {
                    const response = await fetch(`${API_URL}/facebook/auth/url`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        const authWindow = window.open(result.data.authUrl, 'facebook-auth', 'width=500,height=600');
                        
                        window.addEventListener('message', async function(event) {
                            if (event.origin !== window.location.origin) return;
                            
                            if (event.data.type === 'facebook-auth-success') {
                                facebookConnected = true;
                                showFacebookConnected();
                                loadConnectedPages();
                                if (authWindow) authWindow.close();
                            }
                        });
                    } else {
                        alert('Failed to get Facebook authorization URL');
                    }
                } catch (error) {
                    console.error('Error connecting Facebook:', error);
                    alert('Failed to connect Facebook');
                }
            });
            
            // Add event listeners for new features
            addFacebookEventListeners();
        }

        // Disconnect Facebook function
        async function disconnectFacebook() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/facebook/disconnect`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    facebookConnected = false;
                    showFacebookDisconnected();
                    showNotification('Facebook disconnected successfully', 'success');
                    updateFacebookStatus(false, 0);
                } else {
                    showNotification('Failed to disconnect Facebook', 'error');
                }
            } catch (error) {
                console.error('Error disconnecting Facebook:', error);
                showNotification('Failed to disconnect Facebook', 'error');
            }
        }

        // Load connected Facebook pages
        async function loadConnectedPages() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/facebook/pages`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateFacebookStatus(result.data.pages);
                }
            } catch (error) {
                console.error('Error loading Facebook pages:', error);
                showNotification('Failed to load Facebook pages', 'error');
            }
        }

        // Handle Facebook OAuth callback
        function handleFacebookCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            if (error) {
                showNotification('Facebook connection failed: ' + error, 'error');
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (code && state) {
                // This is a Facebook callback - process it
                processFacebookCallback(code, state);
            }
        }

        // Process Facebook OAuth callback
        async function processFacebookCallback(code, state) {
            try {
                showNotification('Processing Facebook connection...', 'info');
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showNotification('Please login first', 'error');
                    return;
                }

                // Exchange code for token via backend
                // The state parameter already contains the JWT token, so we don't need to send it separately
                const response = await fetch(`${API_URL}/facebook/auth/callback?code=${code}&state=${state}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('Facebook connected successfully!', 'success');
                    facebookConnected = true;
                    showFacebookConnected();
                    loadConnectedPages();
                    
                    // Persist and verify Facebook user access token if returned
                    const fbToken = result && result.data && result.data.access_token ? result.data.access_token : null;
                    if (fbToken) {
                        try {
                            localStorage.setItem('fbUserAccessToken', fbToken);
                            const meResp = await fetch(`https://graph.facebook.com/v18.0/me?fields=id,name&access_token=${encodeURIComponent(fbToken)}`);
                            const me = await meResp.json();
                            console.log('Verified Facebook /me (direct callback):', me);
                        } catch (e) {
                            console.warn('Failed to verify /me (direct callback):', e);
                        }
                    }
                    
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    showNotification('Facebook connection failed: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error processing Facebook callback:', error);
                showNotification('Failed to process Facebook callback', 'error');
            }
        }

        // Track which event listeners have been added to prevent duplicates
        let facebookEventListenersAdded = false;
        
        // Add event listeners for new Facebook features
        function addFacebookEventListeners() {
            // Prevent duplicate event listeners
            if (facebookEventListenersAdded) {
                return;
            }
            facebookEventListenersAdded = true;
            // Refresh pages button
            const refreshBtn = document.getElementById('refreshPagesBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    refreshBtn.textContent = 'üîÑ Refreshing...';
                    refreshBtn.disabled = true;
                    try {
                        await loadConnectedPages();
                        showNotification('Pages refreshed successfully', 'success');
                    } catch (error) {
                        showNotification('Failed to refresh pages', 'error');
                    } finally {
                        refreshBtn.textContent = 'üîÑ Refresh Pages';
                        refreshBtn.disabled = false;
                    }
                });
            }

            // Add more pages button
            const addMoreBtn = document.getElementById('addMorePagesBtn');
            if (addMoreBtn) {
                addMoreBtn.addEventListener('click', async () => {
                    // Trigger Facebook connection flow
                    const connectBtn = document.getElementById('connectFacebookBtn');
                    if (connectBtn) {
                        connectBtn.click();
                    }
                });
            }

            // Character count for post content
            const postContent = document.getElementById('postContent');
            if (postContent) {
                postContent.addEventListener('input', () => {
                    const charCount = document.getElementById('charCount');
                    if (charCount) {
                        charCount.textContent = postContent.value.length;
                    }
                });
            }
            
            // Facebook post form - Add it here to prevent duplicates
            const postToFacebookForm = document.getElementById('postToFacebookForm');
            if (postToFacebookForm) {
                postToFacebookForm.addEventListener('submit', handleFacebookPost);
            }
        }

        // Display connected Facebook pages
        function displayConnectedPages(pages) {
            const pagesListDiv = document.getElementById('connectedPagesList');
            
            if (pages.length === 0) {
                pagesListDiv.innerHTML = '<p>No Facebook pages connected yet.</p>';
                return;
            }

            const pagesHTML = pages.map(page => `
                <div class="page-item">
                    <div class="page-info">
                        <div class="page-name">${page.name}</div>
                        <div class="page-details">
                            Category: ${page.category} | 
                            Followers: ${page.fan_count || 'Unknown'} | 
                            Connected: ${new Date(page.created_at).toLocaleDateString()}
                        </div>
                    </div>
                    <div class="page-actions">
                        <button class="disconnect-page-btn" onclick="disconnectPage('${page.facebook_page_id}')">
                            üóëÔ∏è Disconnect
                        </button>
                    </div>
                </div>
            `).join('');

            pagesListDiv.innerHTML = pagesHTML;
        }

        // Update page select dropdown for posting
        function updatePageSelect(pages) {
            const pageSelect = document.getElementById('pageSelect');
            
            // Clear existing options except the first one
            pageSelect.innerHTML = '<option value="">Select a page to post to...</option>';
            
            // Add page options
            pages.forEach(page => {
                const option = document.createElement('option');
                option.value = page.facebook_page_id;
                option.textContent = page.name;
                pageSelect.appendChild(option);
            });
        }

        // Disconnect individual page
        async function disconnectPage(pageId) {
            if (!confirm('Are you sure you want to disconnect this Facebook page?')) {
                return;
            }

            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/facebook/pages/${pageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Page disconnected successfully');
                    loadConnectedPages(); // Refresh the list
                } else {
                    alert('Failed to disconnect page');
                }
            } catch (error) {
                console.error('Error disconnecting page:', error);
                alert('Failed to disconnect page');
            }
        }

        // Facebook Post Form Handler
        document.getElementById('postToFacebookForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!facebookConnected) {
                alert('Please connect your Facebook account first');
                return;
            }

            const pageId = document.getElementById('pageSelect').value;
            const content = document.getElementById('postContent').value.trim();
            const createBtn = document.getElementById('createPostBtn');
            const messageDiv = document.getElementById('postMessage');

            if (!pageId || !content) {
                messageDiv.innerHTML = '<p class="error">Please select a page and enter post content.</p>';
                return;
            }

            // Show loading state
            createBtn.disabled = true;
            createBtn.textContent = 'üìù Posting...';
            messageDiv.innerHTML = '';

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/facebook/post`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pageId: pageId,
                        message: content
                    }),
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = `
                        <p class="success">‚úÖ Post created successfully!</p>
                        <p>Post ID: ${result.data.postId}</p>
                    `;
                    
                    // Clear form
                    document.getElementById('postToFacebookForm').reset();
                } else {
                    messageDiv.innerHTML = `<p class="error">‚ùå Error: ${result.message}</p>`;
                }
            } catch (error) {
                console.error('Error creating Facebook post:', error);
                messageDiv.innerHTML = '<p class="error">‚ùå Failed to create post. Please try again.</p>';
            } finally {
                // Reset button state
                createBtn.disabled = false;
                createBtn.textContent = 'üìù Post to Facebook';
            }
        });

        // Section toggle functionality
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content && toggle) {
                if (content.classList.contains('active')) {
                    content.classList.remove('active');
                    toggle.classList.add('collapsed');
                } else {
                    content.classList.add('active');
                    toggle.classList.remove('collapsed');
                }
            }
        }

        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for Facebook callback first
            handleFacebookCallback();
            
            checkGmailConnection();
            checkFacebookConnection();
            
            // Check if scraper service is available before loading CSV files
            checkScraperService();
            
            // Initialize Facebook event listeners after a short delay to ensure DOM is ready
            setTimeout(() => {
                addFacebookEventListeners();
            }, 100);
            
            // All sections start collapsed by default for cleaner initial view
        });

        // Add this at the top of the script section (after backend URL logic)
        function getScraperURL() {
            const currentHost = window.location.hostname;
            if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                return 'http://localhost:3001';
            }
            return `http://${currentHost}:3001`;
        }
        const SCRAPER_URL = getScraperURL();

        // Enable/disable restrictToPath input based on checkbox
        document.getElementById('restrictToPathEnabled').addEventListener('change', function() {
            document.getElementById('restrictToPath').disabled = !this.checked;
        });

        // Add URL counter for the textarea
        document.getElementById('websiteUrls').addEventListener('input', function() {
            const urls = this.value.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0);
            
            const count = urls.length;
            const maxAllowed = 10;
            
            // Update placeholder or show count somewhere
            if (count > maxAllowed) {
                this.style.borderColor = '#dc3545';
                this.title = `Maximum ${maxAllowed} URLs allowed. You have entered ${count}.`;
            } else {
                this.style.borderColor = '#ddd';
                this.title = `${count} URL(s) entered (max: ${maxAllowed})`;
            }
        });

        // Check if scraper service is available
        async function checkScraperService() {
            try {
                const response = await fetch(`${SCRAPER_URL}/api/csv-files`);
                if (response.ok) {
                    // Scraper service is available, load CSV files
                    loadCSVFiles();
                } else {
                    showScraperUnavailable();
                }
            } catch (error) {
                // Scraper service is not available
                showScraperUnavailable();
            }
        }

        // Show scraper unavailable message
        function showScraperUnavailable() {
            const filesListDiv = document.getElementById('csvFilesList');
            if (filesListDiv) {
                filesListDiv.innerHTML = `
                    <div class="info">
                        ‚ÑπÔ∏è Scraper service is not running. CSV files will be available when you start the scraper.
                    </div>
                `;
            }
        }

        // CSV Files Management Functions
        async function loadCSVFiles() {
            const filesListDiv = document.getElementById('csvFilesList');
            
            try {
                const response = await fetch(`${SCRAPER_URL}/api/csv-files`);
                const data = await response.json();
                
                if (data.success && data.data.files.length > 0) {
                    displayCSVFiles(data.data.files);
                } else {
                    filesListDiv.innerHTML = `
                        <div class="no-files">
                            üì≠ No saved CSV files found. Export some scraping results to see them here.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading CSV files:', error);
                filesListDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Error loading CSV files. Please try again.
                    </div>
                `;
            }
        }

        function displayCSVFiles(files) {
            const filesListDiv = document.getElementById('csvFilesList');
            
            const tableRows = files.map(file => {
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                const createdDate = new Date(file.created).toLocaleString();
                const rowCount = file.metadata.rowCount || 'Unknown';
                
                return `
                    <tr>
                        <td>${file.filename}</td>
                        <td>
                            <span class="csv-file-size">${sizeMB} MB</span><br>
                            <span class="csv-file-date">${rowCount} rows</span>
                        </td>
                        <td>
                            <span class="csv-file-date">${createdDate}</span>
                        </td>
                        <td>
                            <div class="csv-file-actions">
                                <button class="csv-download-btn" onclick="downloadCSVFile('${file.filename}')">
                                    üì• Download
                                </button>
                                <button class="csv-delete-btn" onclick="deleteCSVFile('${file.filename}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            filesListDiv.innerHTML = `
                <table class="csv-files-table">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Size & Rows</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        async function downloadCSVFile(filename) {
            try {
                const response = await fetch(`${SCRAPER_URL}/api/csv-files/${filename}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Error downloading file');
                }
            } catch (error) {
                console.error('Error downloading CSV file:', error);
                alert('Error downloading file');
            }
        }

        async function deleteCSVFile(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${SCRAPER_URL}/api/csv-files/${filename}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('File deleted successfully');
                    loadCSVFiles(); // Refresh the list
                } else {
                    alert(`Error deleting file: ${data.error}`);
                }
            } catch (error) {
                console.error('Error deleting CSV file:', error);
                alert('Error deleting file');
            }
        }

        async function cleanupOldFiles() {
            const daysOld = prompt('Delete files older than how many days? (default: 30)', '30');
            
            if (!daysOld || isNaN(daysOld)) {
                return;
            }
            
            try {
                const response = await fetch(`${SCRAPER_URL}/api/storage/cleanup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ daysOld: parseInt(daysOld) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Cleaned up ${data.deletedCount} old files`);
                    loadCSVFiles(); // Refresh the list
                } else {
                    alert(`Error cleaning up files: ${data.error}`);
                }
            } catch (error) {
                console.error('Error cleaning up old files:', error);
                alert('Error cleaning up files');
            }
        }

        // Add event listeners for CSV file management
        document.getElementById('refreshCsvFilesBtn').addEventListener('click', loadCSVFiles);
        document.getElementById('cleanupOldFilesBtn').addEventListener('click', cleanupOldFiles);

        // Function to export scraping results to CSV
        function exportToCSV(data, originalUrls) {
            const exportBtn = document.getElementById('exportCsvBtn');
            exportBtn.disabled = true;
            exportBtn.textContent = 'üìÑ Generating CSV...';

            try {
                // Prepare data for CSV
                const csvData = prepareCSVData(data, originalUrls);
                
                // Create CSV content
                const csvContent = generateCSVContent(csvData);
                
                // Create and download file
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `email_scraping_results_${timestamp}.csv`;
                
                downloadCSV(csvContent, filename);
                
                // Show success message
                const exportInfo = document.querySelector('.export-info');
                if (exportInfo) {
                    exportInfo.innerHTML = `
                        <div style="color: #28a745; font-weight: bold;">
                            ‚úÖ CSV file downloaded successfully: ${filename}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error exporting to CSV:', error);
                const exportInfo = document.querySelector('.export-info');
                if (exportInfo) {
                    exportInfo.innerHTML = `
                        <div style="color: #dc3545; font-weight: bold;">
                            ‚ùå Error generating CSV: ${error.message}
                        </div>
                    `;
                }
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'üìÑ Export to CSV';
            }
        }

        // Function to prepare data for CSV export
        function prepareCSVData(data, originalUrls) {
            const successfulResults = data.results.filter(r => r.success);
            const csvRows = [];
            
            // Add header row
            csvRows.push([
                'Email',
                'Source URL',
                'Names',
                'Job Titles',
                'Companies',
                'Keywords',
                'Addresses',
                'Social Media',
                'Industries',
                'Seniority',
                'Departments',
                'Scraped At'
            ]);

            // Add data rows
            successfulResults.forEach(result => {
                if (result.emails && result.emails.length > 0) {
                    result.emails.forEach(email => {
                        const personalData = result.personalData && result.personalData[email] ? result.personalData[email] : {};
                        
                        const row = [
                            email,
                            result.url,
                            personalData.names ? personalData.names.join('; ') : '',
                            personalData.jobTitles ? personalData.jobTitles.join('; ') : '',
                            personalData.companies ? personalData.companies.join('; ') : '',
                            personalData.keywords ? personalData.keywords.join('; ') : '',
                            personalData.addresses ? personalData.addresses.join('; ') : '',
                            personalData.socialMedia ? Object.entries(personalData.socialMedia)
                                .map(([platform, profiles]) => `${platform}: ${profiles.join(', ')}`)
                                .join('; ') : '',
                            personalData.industries ? personalData.industries.join('; ') : '',
                            personalData.seniority ? personalData.seniority.join('; ') : '',
                            personalData.departments ? personalData.departments.join('; ') : '',
                            new Date(data.timestamp).toLocaleString()
                        ];
                        
                        csvRows.push(row);
                    });
                }
            });

            return csvRows;
        }

        // Function to generate CSV content
        function generateCSVContent(csvRows) {
            return csvRows.map(row => 
                row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma, quote, or newline
                    const escaped = String(cell).replace(/"/g, '""');
                    if (escaped.includes(',') || escaped.includes('"') || escaped.includes('\n')) {
                        return `"${escaped}"`;
                    }
                    return escaped;
                }).join(',')
            ).join('\n');
        }

        // Function to download CSV file
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Facebook Integration Functions
        async function loadFacebookPages() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/facebook/pages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Facebook pages response:', data);
                    
                    // Ensure we have an array of pages
                    const pages = data.data?.pages || [];
                    if (Array.isArray(pages)) {
                        updateFacebookStatus(pages);
                    } else {
                        console.error('Invalid pages data structure:', pages);
                        updateFacebookStatus([]);
                    }
                } else {
                    console.error('Failed to load Facebook pages:', response.status);
                    updateFacebookStatus([]);
                }
            } catch (error) {
                console.error('Error loading Facebook pages:', error);
                updateFacebookStatus([]);
            }
        }

        function updateFacebookStatus(pages) {
            // Ensure pages is always an array
            if (!Array.isArray(pages)) {
                console.error('updateFacebookStatus called with non-array:', pages);
                pages = [];
            }
            
            const connectionStatus = document.getElementById('connectionStatus');
            const pagesCount = document.getElementById('pagesCount');
            const facebookConnection = document.getElementById('facebookConnection');
            const facebookPages = document.getElementById('facebookPages');
            const facebookPostForm = document.getElementById('facebookPostForm');

            if (!connectionStatus || !pagesCount) return;

            if (pages.length === 0) {
                // No pages connected
                connectionStatus.textContent = 'Not Connected';
                connectionStatus.style.color = '#dc3545';
                pagesCount.textContent = '0 pages';
                
                // Show connection section, hide others
                if (facebookConnection) facebookConnection.style.display = 'block';
                if (facebookPages) facebookPages.style.display = 'none';
                if (facebookPostForm) facebookPostForm.style.display = 'none';
            } else {
                // Pages are connected
                connectionStatus.textContent = 'Connected';
                connectionStatus.style.color = '#28a745';
                pagesCount.textContent = `${pages.length} page(s)`;
                
                // Hide connection section, show others
                if (facebookConnection) facebookConnection.style.display = 'none';
                if (facebookPages) facebookPages.style.display = 'block';
                if (facebookPostForm) facebookPostForm.style.display = 'block';
                
                // Update connected pages list
                updateConnectedPagesList(pages);
                updatePageSelect(pages);
            }
        }

        function updateConnectedPagesList(pages) {
            const connectedPagesList = document.getElementById('connectedPagesList');
            if (!connectedPagesList) return;

            // Ensure pages is an array
            if (!Array.isArray(pages)) {
                console.error('updateConnectedPagesList called with non-array:', pages);
                connectedPagesList.innerHTML = '<div class="error">Error loading pages</div>';
                return;
            }

            connectedPagesList.innerHTML = pages.map(page => `
                <div class="page-item">
                    <div class="page-info">
                        <h4>${page.name}</h4>
                        <p>Category: ${page.category || 'N/A'}</p>
                        <p>Followers: ${page.fan_count || 0}</p>
                    </div>
                    <button onclick="deletePageConnection('${page.facebook_page_id}')" class="btn-danger">üóëÔ∏è Remove</button>
                </div>
            `).join('');
        }

        function updatePageSelect(pages) {
            const pageSelect = document.getElementById('pageSelect');
            if (!pageSelect) return;

            // Ensure pages is an array
            if (!Array.isArray(pages)) {
                console.error('updatePageSelect called with non-array:', pages);
                pageSelect.innerHTML = '<option value="">Error loading pages</option>';
                return;
            }

            pageSelect.innerHTML = '<option value="">Select a page to post to...</option>' +
                pages.map(page => `<option value="${page.facebook_page_id}">${page.name}</option>`).join('');
        }

        // Check Facebook connection status on page load
        async function checkFacebookConnection() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    // No token means not logged in, so no Facebook connection
                    facebookConnected = false;
                    showFacebookDisconnected();
                    updateFacebookStatus([]);
                    return;
                }

                const response = await fetch(`${API_URL}/facebook/status`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                
                if (result.success && result.data.pages && Array.isArray(result.data.pages) && result.data.pages.length > 0) {
                    facebookConnected = true;
                    showFacebookConnected();
                    updateFacebookStatus(result.data.pages);
                } else {
                    facebookConnected = false;
                    showFacebookDisconnected();
                    updateFacebookStatus([]);
                }
            } catch (error) {
                console.error('Error checking Facebook connection:', error);
                facebookConnected = false;
                showFacebookDisconnected();
                updateFacebookStatus([]);
            }
        }

        // Load connected Facebook pages
        async function loadConnectedPages() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/facebook/pages`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (result.success && result.data.pages && Array.isArray(result.data.pages)) {
                    updateFacebookStatus(result.data.pages);
                } else {
                    console.error('Invalid response structure:', result);
                    updateFacebookStatus([]);
                }
            } catch (error) {
                console.error('Error loading Facebook pages:', error);
                showNotification('Failed to load Facebook pages', 'error');
                updateFacebookStatus([]);
            }
        }

        // Connect Facebook function
        async function connectFacebook() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please login first');
                    return;
                }

                const response = await fetch(`${API_URL}/facebook/auth/url`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const authWindow = window.open(result.data.authUrl, 'facebook-auth', 'width=500,height=600');
                    
                    window.addEventListener('message', async function(event) {
                        if (event.origin !== window.location.origin) return;
                        
                        if (event.data.type === 'facebook-auth-success') {
                            if (authWindow) authWindow.close();
                            loadFacebookPages(); // Reload the pages
                            showNotification('Facebook connected successfully!', 'success');
                        }
                    });
                } else {
                    alert('Failed to get Facebook authorization URL');
                }
            } catch (error) {
                console.error('Error connecting Facebook:', error);
                alert('Failed to connect Facebook');
            }
        }

        // Delete page connection function
        async function deletePageConnection(pageId) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please login first');
                    return;
                }

                if (!confirm('Are you sure you want to remove this page connection?')) {
                    return;
                }

                const response = await fetch(`${API_URL}/facebook/pages/${pageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    showNotification('Page connection removed successfully!', 'success');
                    loadFacebookPages(); // Reload the pages
                } else {
                    const result = await response.json();
                    showNotification(`Failed to remove page: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting page connection:', error);
                showNotification('Failed to remove page connection', 'error');
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                max-width: 300px;
                word-wrap: break-word;
            `;

            // Set background color based on type
            switch (type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ffc107';
                    notification.style.color = '#212529';
                    break;
                default:
                    notification.style.backgroundColor = '#17a2b8';
            }

            // Add to page
            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Refresh Facebook pages function
        async function refreshFacebookPages() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please login first');
                    return;
                }

                const response = await fetch(`${API_URL}/facebook/auth/url`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const authWindow = window.open(result.data.authUrl, 'facebook-auth', 'width=500,height=600');
                    
                    window.addEventListener('message', async function(event) {
                        if (event.origin !== window.location.origin) return;
                        
                        if (event.data.type === 'facebook-auth-success') {
                            if (authWindow) authWindow.close();
                            loadFacebookPages(); // Reload the pages
                            showNotification('Facebook pages refreshed successfully!', 'success');
                        }
                    });
                } else {
                    alert('Failed to get Facebook authorization URL');
                }
            } catch (error) {
                console.error('Error refreshing Facebook pages:', error);
                alert('Failed to refresh Facebook pages');
            }
        }

        // Load Facebook pages when dashboard loads
        document.addEventListener('DOMContentLoaded', function() {
            loadFacebookPages();
            
            // Add event listeners for Facebook functionality
            const connectFacebookBtn = document.getElementById('connectFacebookBtn');
            if (connectFacebookBtn) {
                connectFacebookBtn.addEventListener('click', connectFacebook);
            }

            const refreshPagesBtn = document.getElementById('refreshPagesBtn');
            if (refreshPagesBtn) {
                refreshPagesBtn.addEventListener('click', loadFacebookPages);
            }

            const addMorePagesBtn = document.getElementById('addMorePagesBtn');
            if (addMorePagesBtn) {
                addMorePagesBtn.addEventListener('click', connectFacebook);
            }

            // Facebook post form event listener is now handled in addFacebookEventListeners() to prevent duplicates

            // Add character count for post content
            const postContent = document.getElementById('postContent');
            if (postContent) {
                postContent.addEventListener('input', function() {
                    const charCount = document.getElementById('charCount');
                    if (charCount) {
                        charCount.textContent = this.value.length;
                    }
                });
            }
        });

        // Handle Facebook post submission
        async function handleFacebookPost(event) {
            event.preventDefault();
            
            const pageId = document.getElementById('pageSelect').value;
            const content = document.getElementById('postContent').value;
            
            if (!pageId) {
                showNotification('Please select a page to post to', 'error');
                return;
            }
            
            if (!content.trim()) {
                showNotification('Please enter post content', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_URL}/facebook/post`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        pageId: pageId,
                        message: content
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Post created successfully!', 'success');
                    document.getElementById('postContent').value = '';
                    document.getElementById('charCount').textContent = '0';
                } else {
                    showNotification(`Failed to create post: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error creating Facebook post:', error);
                showNotification('Failed to create post', 'error');
            }
        }
    </script>
</body>
</html>